// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String        @id @default(uuid())
  authUserId  String        @unique @default(uuid())
  name        String        @default("anon")
  RoomMessage RoomMessage[]
  RoomUser    RoomUser[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Room {
  id        Int           @id @default(autoincrement())
  name      String
  users     RoomUser[]
  messages  RoomMessage[]
  gameId    String?
  game      Game?         @relation(fields: [gameId], references: [id])
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model RoomMessage {
  id        String   @id @default(uuid())
  roomId    Int
  userId    String
  content   String
  timestamp String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room Room @relation(fields: [roomId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([roomId])
  @@index([userId])
}

model RoomUser {
  userId   String
  roomId   Int
  roomHost Boolean?

  user User @relation(fields: [userId], references: [id])
  room Room @relation(fields: [roomId], references: [id])

  @@id([userId, roomId])
}

model Player {
  id          String        @id @default(uuid())
  nickname    String
  cashOnHand  Float
  gameId      String
  Game        Game          @relation(fields: [gameId], references: [id])
  PlayerStock PlayerStock[]
  GamePlayer  GamePlayer[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model PlayerStock {
  playerId            String
  stockId             String
  ownershipPercentage Float

  Player Player @relation(fields: [playerId], references: [id])
  Stock  Stock  @relation(fields: [stockId], references: [id])

  @@id([playerId, stockId])
}

model Stock {
  id           String         @id @default(uuid())
  currentPrice Float
  companyId    String
  location     String
  gameId       String
  Company      Company        @relation(fields: [companyId], references: [id])
  StockHistory StockHistory[]
  PlayerStock  PlayerStock[]
  CompanyStock CompanyStock[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Company {
  id                 String         @id @default(uuid())
  name               String
  unitPrice          Float
  throughput         Int
  sectorId           String
  gameId             String
  insolvent          Boolean
  currentStockPrice  Float?
  cashOnHand         Float?
  mergedWithParent   String?
  mergedWithChildren Json?
  Sector             Sector         @relation(fields: [sectorId], references: [id])
  Game               Game           @relation(fields: [gameId], references: [id])
  CompanyStock       CompanyStock[]
  Stock              Stock[]
  GameCompany        GameCompany[]
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
}

model CompanyStock {
  companyId String
  stockId   String

  Company Company @relation(fields: [companyId], references: [id])
  Stock   Stock   @relation(fields: [stockId], references: [id])

  @@id([companyId, stockId])
}

model StockHistory {
  id                Int      @id @default(autoincrement())
  stockId           String
  price             Float
  productionRevenue Float
  gameId            String
  timestamp         Int
  Stock             Stock    @relation(fields: [stockId], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model StockRound {
  id        Int      @id @default(autoincrement())
  phase     String
  gameId    String
  Game      Game     @relation(fields: [gameId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OperatingRound {
  id        Int      @id @default(autoincrement())
  actions   Json
  gameId    String
  Game      Game     @relation(fields: [gameId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ResearchDeck {
  id        Int      @id @default(autoincrement())
  gameId    String
  cards     Card[]
  Game      Game     @relation(fields: [gameId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Card {
  id           Int          @id @default(autoincrement())
  name         String
  description  String
  effect       Json
  deckId       Int
  ResearchDeck ResearchDeck @relation(fields: [deckId], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model Sector {
  id             String    @id @default(uuid())
  name           String
  supply         Int
  demand         Int
  marketingPrice Float
  basePrice      Float
  floatNumberMin Int
  floatNumberMax Int
  Company        Company[]
  Game           Game?     @relation(fields: [gameId], references: [id])
  gameId         String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Game {
  id                  String           @id @default(uuid())
  name                String
  currentTurn         Int
  currentOrSubRound   Int
  currentRound        String
  currentActivePlayer String?
  bankPoolNumber      Int
  consumerPoolNumber  Int
  gameStatus          String
  sectors             Sector[]
  players             GamePlayer[]
  companies           GameCompany[]
  Player              Player[]
  Company             Company[]
  StockRound          StockRound[]
  OperatingRound      OperatingRound[]
  ResearchDeck        ResearchDeck[]
  Room                Room[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
}

model GamePlayer {
  gameId   String
  playerId String

  Game   Game   @relation(fields: [gameId], references: [id])
  Player Player @relation(fields: [playerId], references: [id])

  @@id([gameId, playerId])
}

model GameCompany {
  gameId    String
  companyId String

  Game    Game    @relation(fields: [gameId], references: [id])
  Company Company @relation(fields: [companyId], references: [id])

  @@id([gameId, companyId])
}
